PROGRAM DRIVER
USE CONSTANTS
USE MATH_MODULE
USE ORBITAL_FUNCTIONS
use COST_MODULE
USE OPTIMIZATION_MODULE
use omp_lib
IMPLICIT NONE

INTEGER :: N_POP, N_GEN, N_INT, N_DOUBLE, N_RUNS, N1,N2, NCON, ITER_MAX_MBH, ITER_MAX_NLP, N_CON
INTEGER, ALLOCATABLE :: INTEGER_UPPER(:)
INTEGER, ALLOCATABLE :: INTEGER_LOWER(:)
DOUBLE PRECISION :: P_CROSS, P_REP,P_MUT 
DOUBLE PRECISION, ALLOCATABLE :: DOUBLE_UPPER(:), DOUBLE_LOWER(:), INPUT_ARRAY(:,:)
CHARACTER(LEN=30) :: CROSSOVER_TYPE, MUTATION_TYPE, SELECTION_TYPE, OPTIMIZATION_TYPE

INTEGER, ALLOCATABLE :: INTEGER_RUN(:,:), CHROM_INT(:)
DOUBLE PRECISION, ALLOCATABLE :: MIN_RUN(:), AVG_RUN(:), DOUBLE_RUN(:,:), LAST_HALF_CHANGE(:)

INTEGER :: SEED,  COUNT1, COUNT2, RATE, I, J, MIN_LOC, IPRINT, COUNT, NGEN_CONVERGE
DOUBLE PRECISION :: TIME , FITNESS_INDV, TOL_CONVERGE, MAX_TIME
DOUBLE PRECISION, ALLOCATABLE :: FITNESS_AVG(:), FITNESS_MIN(:), DOUBLE_MIN(:,:), X0(:), X(:)
INTEGER, ALLOCATABLE :: INTEGER_MIN(:,:)

! PROBLEM SPECIFIC VARIABLES
INTEGER :: yi, mi, di, hi, mini, si
INTEGER :: yf, mf, df, hf, minf, sf
INTEGER :: ERROR, N_PATCHES, INDEX
DOUBLE PRECISION :: J_MIN, J_MAX, J_CA, M_AST
CHARACTER(LEN=350) :: DUM1, ASTEROID_NAME

DOUBLE PRECISION :: DUM(13)
!SEED FOR FIRST RANDOM NUMBER GENERATION
SEED=-54563872
M_AST=100000.D0


!IF AN INPUT ARRAY OF INFORMATION NEEDS TO BE PASSED TO THE COST FUNCTION USE
!INPUT_ARRAY WHICH HAS A SIZE OF N1, N2

!ASTEROID_NAME="2009 BD"
!yi=2026
!mi=1
!di=1
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2013 EC20"
!yi=2026
!mi=1
!di=1
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2006 RH120"
!yi=2028
!mi=10
!di=10
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2008 HU4"
!yi=2026
!mi=3
!di=27
!hi=12
!mini=0
!si=0

ASTEROID_NAME="2000 SG344"
yi=2029
mi=2
di=16
hi=12
mini=0
si=0

!ASTEROID_NAME="2004 EO20"
!yi=2031
!mi=6
!di=10
!hi=12
!mini=0
!si=0


!ASTEROID_NAME="1998 HG49"
!yi=2031
!mi=7
!di=21
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2011 MD"
!yi=2029
!mi=1
!di=1
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2012 TF79"
!yi=2027
!mi=2
!di=27
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2012 LA"
!yi=2029
!mi=12
!di=25
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="1996 XB27"
!yi=2027
!mi=7
!di=29
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2011 AA37"
!yi=2026
!mi=8
!di=26
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2010 UE51"
!yi=2023
!mi=12
!di=24
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2014 BA3"
!yi=2024
!mi=4
!di=23
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2013 UX2"
!yi=2026
!mi=12
!di=21
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2007 UN12"
!yi=2020
!mi=9
!di=1
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2008 EA9"
!yi=2020
!mi=4
!di=24
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2008 UA202" 
!yi=2029
!mi=10
!di=20
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2011 BL45" 
!yi=2029
!mi=7
!di=2
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2004 QA22" 
!yi=2030
!mi=11
!di=20
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2009 UD" 
!yi=2027
!mi=10
!di=28
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2013 GH66" 
!yi=2027
!mi=5
!di=24
!hi=12
!mini=0
!si=0

!ASTEROID_NAME="2008 JL24" 
!yi=2026
!mi=6
!di=21
!hi=12
!mini=0
!si=0


OPEN(1,FILE=TRIM(ASTEROID_NAME)//'.txt')
ERROR=0
COUNT=0
DO WHILE(ERROR.EQ.0)
    READ(1,'(a)',IOSTAT=ERROR) DUM1
    IF (ERROR.EQ.0) THEN
        COUNT=COUNT+1
    END IF
END DO
CLOSE(1)
!WRITE(*,*) COUNT
N1=COUNT-75
N2=13

write(*,*) n1, n2
ALLOCATE(INPUT_ARRAY(N1,N2))

!WRITE(*,*) "STARTING EPHEMERIS"
CALL EPHEMERIS_READER(INPUT_ARRAY,N1,N2,ASTEROID_NAME, 10)

J_CA=jdate(yi,mi,di,hi,mini,si)
!Assume the launch should occur
J_MIN=J_CA-10.D0*365.D0
J_MAX=J_CA-6.D0*365.D0

!PROBLEM INPUTS

P_CROSS=0.9D0
P_REP=1.D0-P_CROSS
P_MUT=0.5D0
N_POP=50
N_GEN=500
N_INT=2

N_PATCHES=10
N_DOUBLE=9+6*N_PATCHES
N_CON=4
!N_CON=0
N_RUNS=500
IPRINT=1
NGEN_CONVERGE=50
MAX_TIME=1000.D0
TOL_CONVERGE=1.D-5

!MAXIMUM NUMBER OF ITERATIONS EACH NLP SOLVER CALL IS ALLOWED
ITER_MAX_NLP=250
! MAXIMUM NUMBER OF BAD SOLUTIONS ALLOWED WHEN THE MONOTONIC BASIN HOPPING OPTIMIZATION METHOD IS USED



!OPTIMIZATION TYPES INCLUDE:
!   GEN - PURE GENETIC ALGORITHM OPTIMIZATION
!   HYB - HYBRID ALGORITHM THAT ITERATES ON THE COST FUNCTION WITH A TRADITIONAL 
!         NLP SOLVER
!   ALT - ALTERNATES 10 GENERATIONS OF PURE GENETIC ALGORITHM AND 10 GENERATIONS 
!         OF THE HYBRID ALGORITHM
!OPTIMIZATION_TYPE="HYB_COBYLA"
OPTIMIZATION_TYPE="HYB_CONMIN"
!OPTIMIZATION_TYPE="HYB_UNCMIN"
!OPTIMIZATION_TYPE="GEN"
!OPTIMIZATION PARAMETERS TYPES
CROSSOVER_TYPE="DOUBLE_POINT"
MUTATION_TYPE="UNIFORM"
SELECTION_TYPE="ROULETTE"

!ALLOCATE VARIABLE LIMIT ARRAYS HERE
ALLOCATE(INTEGER_LOWER(N_INT))
ALLOCATE(INTEGER_UPPER(N_INT))

ALLOCATE(DOUBLE_LOWER(N_DOUBLE))
ALLOCATE(DOUBLE_UPPER(N_DOUBLE))


!INTEGER INPUT BOUNDS
INTEGER_UPPER(1)=3
INTEGER_UPPER(2)=10


INTEGER_LOWER(1)=3
INTEGER_LOWER(2)=10

DOUBLE_UPPER=0.D0
DOUBLE_LOWER=0.D0

DOUBLE_UPPER(1)=J_MAX               !DEPARTURE DATE
DOUBLE_UPPER(2)=2.D0*PI             !DEPARTURE ALPHA
DOUBLE_UPPER(3)=PI/2.D0             !DEPARURE BETA
DOUBLE_UPPER(4)=365.D0*4.D0         !TOF TO ASTEROID
DOUBLE_UPPER(5)=2.D0*365.D0              !ASTEROID STAY TIME
DOUBLE_UPPER(6)=365.D0*10.D0        !RETURN TOF
DOUBLE_UPPER(7)=2.D0                !RETURN C3
DOUBLE_UPPER(8)=2.D0*PI             !RETURN ALPHA
DOUBLE_UPPER(9)=PI/2.D0             !RETURN ALPHA

DOUBLE_LOWER(1)=J_MIN
DOUBLE_LOWER(2)=-2.D0*PI
DOUBLE_LOWER(3)=-PI/2.D0
DOUBLE_LOWER(4)=250.D0
DOUBLE_LOWER(5)=90.D0
DOUBLE_LOWER(6)=250.D0
DOUBLE_LOWER(7)=0.0001D0
DOUBLE_LOWER(8)=-2.D0*PI
DOUBLE_LOWER(9)=-PI/2.D0


!UPDATE FOR 2008 HU4                              
!DOUBLE_UPPER(1)=2457621.4195578271D0+30.D0
!DOUBLE_UPPER(4)=751.15745908991039D0*1.05D0
!DOUBLE_UPPER(5)=207.92228735309564D0*1.05D0
!DOUBLE_UPPER(6)=2574.2014433716349D0*1.05D0
!DOUBLE_LOWER(1)=2457621.4195578271D0-30.D0
!DOUBLE_LOWER(4)=751.15745908991039D0*0.95D0
!DOUBLE_LOWER(5)=207.92228735309564D0*0.95D0
!DOUBLE_LOWER(6)=2574.2014433716349D0*0.95D0     
       
       
       
!UPDATES FOR 2006 RH120
                  
!DOUBLE_UPPER(1)=2459670.4093812876D0+30.D0
!DOUBLE_UPPER(4)=738.93598145216299D0*1.05D0
!DOUBLE_UPPER(5)=301.65400071434203D0*1.05D0
!DOUBLE_UPPER(6)=1783.0728757437457D0*1.05D0
!DOUBLE_LOWER(1)=2459670.4093812876D0-30.D0
!DOUBLE_LOWER(4)=738.93598145216299D0*0.95D0
!DOUBLE_LOWER(5)=301.65400071434203D0*0.95D0
!DOUBLE_LOWER(6)=1783.0728757437457D0*0.95D0


!2000 SG344
!DOUBLE_UPPER(1)=2459675.6227075863D0+30.D0
!DOUBLE_UPPER(4)=1176.1400935007891D0*1.05D0
!DOUBLE_UPPER(5)=345.04292044689464D0*1.05D0 
!DOUBLE_UPPER(6)=706.27875951251247D0*1.05D0 
!DOUBLE_lOWER(1)=2459675.6227075863D0-30.D0
!DOUBLE_LOWER(4)=1176.1400935007891D0*0.95D0
!DOUBLE_LOWER(5)=345.04292044689464D0*0.95D0 
!DOUBLE_LOWER(6)=706.27875951251247D0*0.95D0

!2004 EO4


!2011 MD
!DOUBLE_UPPER(1)=2458582.9134676768D0+30.D0
!DOUBLE_UPPER(4)=1353.8512574246211*1.05D0
!DOUBLE_UPPER(5)=127.90964643189491D0*1.05D0 
!DOUBLE_UPPER(6)=719.27857111209403D0*1.05D0 
!DOUBLE_lOWER(1)=2458582.9134676768D0-30.D0
!DOUBLE_LOWER(4)=1353.8512574246211*0.95D0
!DOUBLE_LOWER(5)=127.90964643189491D0*0.95D0 
!DOUBLE_LOWER(6)=719.27857111209403D0*0.95D0

INDEX=10
DOUBLE_UPPER(INDEX:INDEX+N_PATCHES-1)=1.D0
DOUBLE_LOWER(INDEX:INDEX+N_PATCHES-1)=1.D-5
INDEX=INDEX+N_PATCHES
DOUBLE_UPPER(INDEX:INDEX+N_PATCHES-1)=2.D0*PI
DOUBLE_LOWER(INDEX:INDEX+N_PATCHES-1)=-2.D0*PI
INDEX=INDEX+N_PATCHES
DOUBLE_UPPER(INDEX:INDEX+N_PATCHES-1)=178.D0*PI/180
DOUBLE_LOWER(INDEX:INDEX+N_PATCHES-1)=2.D0*PI/180

INDEX=INDEX+N_PATCHES
DOUBLE_UPPER(INDEX:INDEX+N_PATCHES-1)=1.D0
DOUBLE_LOWER(INDEX:INDEX+N_PATCHES-1)=1.D-5
INDEX=INDEX+N_PATCHES
DOUBLE_UPPER(INDEX:INDEX+N_PATCHES-1)=2.D0*PI
DOUBLE_LOWER(INDEX:INDEX+N_PATCHES-1)=-2.D0*PI
INDEX=INDEX+N_PATCHES
DOUBLE_UPPER(INDEX:INDEX+N_PATCHES-1)=178.D0*PI/180
DOUBLE_LOWER(INDEX:INDEX+N_PATCHES-1)=2.D0*PI/180


!DO I=1,6*N_PATCHES,1
!    ! EPSILON-LEG 1
!    DOUBLE_UPPER(I+9)=1.D0
!    DOUBLE_LOWER(I+9)=1.D-5
!    ! THETA-LEG 1
!    DOUBLE_UPPER(I+9+N_PATCHES)=2.D0*PI
!    DOUBLE_LOWER(I+9+N_PATCHES)=-2.D0*PI
!    ! PHI-LEG 1
!    DOUBLE_UPPER(I+9+2*N_PATCHES)=178.D0*PI/180.D0
!    DOUBLE_LOWER(I+9+2*N_PATCHES)=2.D0*PI/180.D0
!    ! EPSILON-LEG 2
!    DOUBLE_UPPER(I+9+3*N_PATCHES)=1.D0
!    DOUBLE_LOWER(I+9+3*N_PATCHES)=1.D-5
!    ! THETA-LEG 2
!    DOUBLE_UPPER(I+9+4*N_PATCHES)=2.D0*PI
!    DOUBLE_LOWER(I+9+4*N_PATCHES)=-2.D0*PI
!    ! PHI-LEG 2
!    DOUBLE_UPPER(I+9+5*N_PATCHES)=178.D0*PI/180.D0
!    DOUBLE_LOWER(I+9+5*N_PATCHES)=2.D0*PI/180.D0
!END DO


!WRITE(*,*) J_MAX, J_MIN
!WRITE(*,*) DOUBLE_UPPER(1), DOUBLE_LOWER(1)
!
!DO I=1,N_DOUBLE,1
!    WRITE(*,*) I, DOUBLE_UPPER(I), DOUBLE_LOWER(I)
!END DO

!DO I=10,N_DOUBLE,1
!  DOUBLE_UPPER(I)=1.D0
!  DOUBLE_LOWER(I)=0.D0
!END DO

!write(*,*) j_max, j_min
! DO I=3,11,1
!     IF (NOMINAL(I).GT.0.D0) THEN
!         DOUBLE_UPPER(I)=NOMINAL(I)*1.2D0
!         DOUBLE_LOWER(I)=NOMINAL(I)*0.8D0
!     ELSE
!         DOUBLE_UPPER(I)=NOMINAL(I)*0.8D0
!         DOUBLE_LOWER(I)=NOMINAL(I)*1.2D0    
!     END IF
! END DO

!********************************************************************************************!
! START TIMER
CALL SYSTEM_CLOCK(COUNT1,RATE)


!FIRST A LARGE NUMBER OF RUNS WITH A SMALL POPULATION AN THOUSANDS OF ITERATIONS ARE PERFORMED
!THIS IS DONE TO FIND AN APPROXIMATE SOLUTION IN ORDER TO LIMIT THE LOWER AND UPPER LIMITS FOR
!THE HYBRID ALGORITHM
!N_GEN=50
!N_POP=50
!N_RUNS=5000
!OPTIMIZATION_TYPE="GEN"

ALLOCATE(FITNESS_AVG(N_GEN), FITNESS_MIN(N_GEN))
ALLOCATE(INTEGER_MIN(N_GEN, N_INT))
ALLOCATE(DOUBLE_MIN(N_GEN, N_DOUBLE))
ALLOCATE(INTEGER_RUN(N_RUNS, N_INT), MIN_RUN(N_RUNS), AVG_RUN(N_RUNS))
ALLOCATE(DOUBLE_RUN(N_RUNS,N_DOUBLE), LAST_HALF_CHANGE(N_RUNS))
ALLOCATE(X0(N_DOUBLE), X(N_DOUBLE), CHROM_INT(N_INT))

WRITE(*,*) "ASTEROID NAME    ", TRIM(ASTEROID_NAME)
WRITE(*,*) "ASTEROID MASS", M_AST
DO I=1,N_RUNS,1
    
    ! START GENETIC ALGORITHM
    !WRITE(*,*) "CALLING GENETIC DRIVER"
CALL GNLP_DRIVER(IPRINT, N_POP, N_GEN, N_INT, N_DOUBLE, N1, N2, ITER_MAX_NLP, &
    N_CON, INTEGER_UPPER, INTEGER_LOWER, P_CROSS, P_REP,P_MUT, DOUBLE_UPPER, &
    DOUBLE_LOWER, INPUT_ARRAY, CROSSOVER_TYPE, MUTATION_TYPE, &
    SELECTION_TYPE, OPTIMIZATION_TYPE, SEED, FITNESS_MIN, FITNESS_AVG, &
    INTEGER_MIN, DOUBLE_MIN, MAX_TIME, NGEN_CONVERGE, TOL_CONVERGE)
    
    CALL SYSTEM_CLOCK(COUNT2)
    TIME=DBLE(COUNT2-COUNT1)/DBLE(RATE)
    MIN_RUN(I)=FITNESS_MIN(N_GEN)
    
    DOUBLE_RUN(I,1:N_DOUBLE)=DOUBLE_MIN(N_GEN,1:N_DOUBLE)
    INTEGER_RUN(I,1:N_INT)=INTEGER_MIN(N_GEN,1:N_INT)
    WRITE(*,*) "ASTEROID NAME    ", TRIM(ASTEROID_NAME)
    WRITE(*,*) "ASTEROID MASS", M_AST
    WRITE(*,*) TIME, I, MIN_RUN(I)!, INTEGER_RUN(I,1:N_INT), DOUBLE_RUN(I,1:N_DOUBLE)  
    OPEN(1,FILE='GENETIC_OUTPUT_SIMS'//trim(ASTEROID_NAME)//'.TXT',ACCESS='APPEND')
    WRITE(1,*) M_AST, INTEGER_RUN(i,1:N_INT), MIN_RUN(I), DOUBLE_RUN(i,1:N_DOUBLE)
    close(1)
END DO

!GET TIME

CALL SYSTEM_CLOCK(COUNT2)
TIME=DBLE(COUNT2-COUNT1)/DBLE(RATE)

!MIN_LOC=MINLOC(MIN_RUN,1)

!WRITE(*,*) "THE BEST SOLUTION IS:"
!
!WRITE(*,*) MIN_RUN(MIN_LOC)
!
!OPEN(1,FILE="nominal_solution.txt")
!WRITE(1,*) N_DOUBLE
!WRITE(1,*) DOUBLE_RUN(MIN_LOC,1:N_DOUBLE)

!CLOSE(1)
!WRITE(*,*) "AVERAGE FITNESS: ", SUM(MIN_RUN)/DBLE(N_RUNS)
!WRITE(*,*) "50% CHANGE AVG:  ", SUM(LAST_HALF_CHANGE)/DBLE(N_RUNS)
!WRITE(*,*) "TOTAL RUN TIME   ", TIME
!WRITE(*,*) "CROSSOVER TYPE:  ", TRIM(CROSSOVER_TYPE)
!WRITE(*,*) "MUTATION  TYPE:  ", TRIM(MUTATION_TYPE) 

!OPEN(1,FILE='GENETIC_OUTPUT_MULTIPLE.TXT')!,ACCESS='APPEND')
!WRITE(1,*) "CROSSOVER TYPE:          ", TRIM(CROSSOVER_TYPE)
!WRITE(1,*) "MUTATION  TYPE:          ", TRIM(MUTATION_TYPE) 
!WRITE(1,*) "TOTAL RUN TIME:          ", TIME
!WRITE(1,*) "CROSSOVER PROBABILITY:   ", P_CROSS
!WRITE(1,*) "REPRODUCTION PROBABILITY:", P_REP
!WRITE(1,*) "MUTATION PROBABILITY:    ", P_MUT
!WRITE(1,*) "POPULATION SIZE:         ", N_POP
!WRITE(1,*) "NUMBER OF GENERATIONS    ", N_GEN
!WRITE(1,*) "NUMBER OF GA RUNS:       ", N_RUNS
!WRITE(1,*) "*************************"
!WRITE(1,*) "THE BEST SOLUTION IS:"
!WRITE(1,'(F17.6, 4X)', ADVANCE='NO') MIN_RUN(MIN_LOC)
!DO J=1,N_INT
!    WRITE(1,'(I2, 4X)', ADVANCE='NO') INTEGER_RUN(MIN_LOC,J)
!END DO
!
!DO J=1,N_DOUBLE,1
!    IF( J.LT.N_DOUBLE) THEN
!        WRITE(1,'(F17.6, 4X)', ADVANCE='NO') DOUBLE_RUN(MIN_LOC,J)
!    ELSE
!        WRITE(1,'(F17.6, 4X)', ADVANCE='YES') DOUBLE_RUN(MIN_LOC,J)
!    END IF
!END DO 
!WRITE(1,*) "*************************"
!WRITE(1,*) "         "
!WRITE(1,*) "*************************"
!WRITE(1,*) "ALL OF THE SOLUTIONS ARE:"    
!WRITE(1,*) "*************************"
!
!DO I=1,N_RUNS,1
!
!    WRITE(1,*) MIN_RUN(I), INTEGER_RUN(I, 1:N_INT), DOUBLE_RUN(I,1:N_DOUBLE)
!    !WRITE(1,'(F17.6, 4X)', ADVANCE='NO') MIN_RUN(I)
!    !DO J=1,N_INT
!    !    WRITE(1,'(I2, 4X)', ADVANCE='NO') INTEGER_RUN(I,J)
!    !END DO
!
!    !DO J=1,N_DOUBLE,1
!    !    IF( J.LT.N_DOUBLE) THEN
!    !        WRITE(1,'(F17.6, 4X)', ADVANCE='NO') DOUBLE_RUN(I,J)
!    !    ELSE
!    !        WRITE(1,'(F17.6, 4X)', ADVANCE='NO') DOUBLE_RUN(I,J)
!    !    END IF
!    !END DO 
!    
!    !WRITE(1,'(A7)',ADVANCE='YES') TRIM(OPTIMIZATION_TYPE)
!END DO

!PERFORM CLEAN UP OPERATIONS HERE.  THIS ISN'T REQUIRED, BUT IT KEEPS THE INTEL ANALYZER HAPPY
!DEALLOCATE(INTEGER_LOWER, INTEGER_UPPER, DOUBLE_LOWER, DOUBLE_UPPER)
!DEALLOCATE(FITNESS_AVG, FITNESS_MIN, INTEGER_MIN, DOUBLE_MIN, INPUT_ARRAY)

END PROGRAM DRIVER
